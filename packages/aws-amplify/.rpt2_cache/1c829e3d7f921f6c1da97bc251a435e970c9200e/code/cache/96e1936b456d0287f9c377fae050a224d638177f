{"code":"/*\r\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\r\n * the License. A copy of the License is located at\r\n *\r\n *     http://aws.amazon.com/apache2.0/\r\n *\r\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\r\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\r\n * and limitations under the License.\r\n */\r\nimport { getCurrTime, getByteLength, defaultConfig, isInteger } from './Utils';\r\nimport { ConsoleLogger as Logger } from '../Common';\r\nvar logger = new Logger('StorageCache');\r\n/**\r\n * Initialization of the cache\r\n *\r\n */\r\nvar StorageCache = /** @class */ (function () {\r\n    /**\r\n     * Initialize the cache\r\n     * @param config - the configuration of the cache\r\n     */\r\n    function StorageCache(config) {\r\n        this.config = Object.assign({}, config);\r\n        this.cacheCurSizeKey = this.config.keyPrefix + 'CurSize';\r\n        this.checkConfig();\r\n    }\r\n    StorageCache.prototype.checkConfig = function () {\r\n        // check configuration\r\n        if (!isInteger(this.config.capacityInBytes)) {\r\n            logger.error('Invalid parameter: capacityInBytes. It should be an Integer. Setting back to default.');\r\n            this.config.capacityInBytes = defaultConfig.capacityInBytes;\r\n        }\r\n        if (!isInteger(this.config.itemMaxSize)) {\r\n            logger.error('Invalid parameter: itemMaxSize. It should be an Integer. Setting back to default.');\r\n            this.config.itemMaxSize = defaultConfig.itemMaxSize;\r\n        }\r\n        if (!isInteger(this.config.defaultTTL)) {\r\n            logger.error('Invalid parameter: defaultTTL. It should be an Integer. Setting back to default.');\r\n            this.config.defaultTTL = defaultConfig.defaultTTL;\r\n        }\r\n        if (!isInteger(this.config.defaultPriority)) {\r\n            logger.error('Invalid parameter: defaultPriority. It should be an Integer. Setting back to default.');\r\n            this.config.defaultPriority = defaultConfig.defaultPriority;\r\n        }\r\n        if (this.config.itemMaxSize > this.config.capacityInBytes) {\r\n            logger.error('Invalid parameter: itemMaxSize. It should be smaller than capacityInBytes. Setting back to default.');\r\n            this.config.itemMaxSize = defaultConfig.itemMaxSize;\r\n        }\r\n        if (this.config.defaultPriority > 5 || this.config.defaultPriority < 1) {\r\n            logger.error('Invalid parameter: defaultPriority. It should be between 1 and 5. Setting back to default.');\r\n            this.config.defaultPriority = defaultConfig.defaultPriority;\r\n        }\r\n        if (Number(this.config.warningThreshold) > 1 || Number(this.config.warningThreshold) < 0) {\r\n            logger.error('Invalid parameter: warningThreshold. It should be between 0 and 1. Setting back to default.');\r\n            this.config.warningThreshold = defaultConfig.warningThreshold;\r\n        }\r\n        // set 5MB limit\r\n        var cacheLimit = 5 * 1024 * 1024;\r\n        if (this.config.capacityInBytes > cacheLimit) {\r\n            logger.error('Cache Capacity should be less than 5MB. Setting back to default. Setting back to default.');\r\n            this.config.capacityInBytes = defaultConfig.capacityInBytes;\r\n        }\r\n    };\r\n    /**\r\n    * produce a JSON object with meta-data and data value\r\n    * @param value - the value of the item\r\n    * @param options - optional, the specified meta-data\r\n    *\r\n    * @return - the item which has the meta-data and the value\r\n    */\r\n    StorageCache.prototype.fillCacheItem = function (key, value, options) {\r\n        var ret = {\r\n            key: key,\r\n            data: value,\r\n            timestamp: getCurrTime(),\r\n            visitedTime: getCurrTime(),\r\n            priority: options.priority,\r\n            expires: options.expires,\r\n            type: typeof value,\r\n            byteSize: 0\r\n        };\r\n        ret.byteSize = getByteLength(JSON.stringify(ret));\r\n        // for accurate size\r\n        ret.byteSize = getByteLength(JSON.stringify(ret));\r\n        return ret;\r\n    };\r\n    /**\r\n     * set cache with customized configuration\r\n     * @param config - customized configuration\r\n     *\r\n     * @return - the current configuration\r\n     */\r\n    StorageCache.prototype.configure = function (config) {\r\n        if (!config) {\r\n            return this.config;\r\n        }\r\n        if (config.keyPrefix) {\r\n            logger.warn(\"Don't try to configure keyPrefix!\");\r\n        }\r\n        this.config = Object.assign({}, this.config, config, config.Cache);\r\n        this.checkConfig();\r\n        return this.config;\r\n    };\r\n    return StorageCache;\r\n}());\r\nexport default StorageCache;\r\n//# sourceMappingURL=StorageCache.js.map","map":"{\"version\":3,\"file\":\"StorageCache.js\",\"sourceRoot\":\"\",\"sources\":[\"../src/Cache/StorageCache.ts\"],\"names\":[],\"mappings\":\"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\"}"}
